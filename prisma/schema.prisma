generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ASSET MANAGEMENT
// Training videos, headshots, voice configurations
// ============================================================================

enum AssetType {
  TRAINING_VIDEO
  HEADSHOT
  VOICE_SAMPLE
  BACKGROUND
  SOUND_EFFECT
  SCENE_IMAGE     // Complete scene images (created in external tools like Nano Banana)
  LORA_MODEL      // Digital Twin: .safetensors file for identity persistence
}

enum AssetStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

model Asset {
  id              String       @id @default(cuid())
  name            String
  type            AssetType
  status          AssetStatus  @default(UPLOADING)

  r2Key           String
  r2Url           String?
  mimeType        String
  sizeBytes       BigInt        // BigInt to support files >2GB

  duration        Int?         // Duration in seconds (for video/audio)
  width           Int?
  height          Int?

  elevenLabsVoiceId String?    // For voice assets
  folder          String?      // Organizational folder (e.g., "Conference Scenes")

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  scenes          Scene[]      @relation("SceneHeadshot")

  @@index([type])
  @@index([status])
  @@index([folder])
}

// ============================================================================
// PROJECT & SCENE MANAGEMENT
// ============================================================================

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  FAILED
}

model Project {
  id              String         @id @default(cuid())
  name            String
  description     String?
  status          ProjectStatus  @default(DRAFT)

  finalVideoUrl   String?
  thumbnailUrl    String?
  totalDuration   Int?

  defaultVoiceId  String?

  scenes          Scene[]
  logs            GenerationLog[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
}

enum SceneStatus {
  DRAFT
  GENERATING_AUDIO
  GENERATING_IMAGE
  GENERATING_VIDEO
  APPLYING_LIPSYNC
  ADDING_SOUND_FX
  COMPLETED
  FAILED
}

model Scene {
  id              String       @id @default(cuid())
  projectId       String
  project         Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  orderIndex      Int

  // Scene prompts
  environment     String?      @db.Text
  wardrobe        String?      @db.Text
  movement        String?      @db.Text
  camera          String?      @db.Text
  dialogue        String?      @db.Text
  soundEffects    String?      @db.Text

  targetDuration  Int          @default(15)
  moodLighting    String       @default("cinematic")

  status          SceneStatus  @default(DRAFT)

  // Generated outputs
  audioUrl        String?
  audioDuration   Int?
  voiceId         String?
  audioModel      String?      // e.g., "eleven_multilingual_v2"

  imageUrl        String?
  imagePrompt     String?      @db.Text
  imageModel      String?      // e.g., "Qubico/flux1-schnell"

  rawVideoUrl     String?
  videoPrompt     String?      @db.Text
  videoDuration   Int?
  videoModel      String?      // e.g., "kling"
  videoMode       String?      // e.g., "pro" or "std"

  lipsyncVideoUrl String?
  lipsyncModel    String?      // e.g., "lipsync-2"
  finalVideoUrl   String?
  thumbnailUrl    String?

  // Headshot override (Standard Mode)
  headshotId      String?
  headshot        Asset?       @relation("SceneHeadshot", fields: [headshotId], references: [id])

  // Identity profile (Digital Twin Mode)
  identityId      String?
  identity        IdentityProfile? @relation("SceneIdentity", fields: [identityId], references: [id])

  // Generation mode tracking
  generationMode  String?      // "standard" or "digital-twin"

  // Error tracking
  failureReason   String?      @db.Text
  retryCount      Int          @default(0)
  lastAttemptAt   DateTime?

  logs            GenerationLog[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([projectId, orderIndex])
  @@index([status])
}

// ============================================================================
// LOGGING
// ============================================================================

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

enum GenerationStep {
  AUDIO_GENERATION
  IMAGE_GENERATION
  IDENTITY_ANCHOR      // Digital Twin: LoRA-based identity rendering
  VIDEO_GENERATION
  LIPSYNC_APPLICATION
  SOUND_FX_MIXING
  VIDEO_ASSEMBLY
}

model GenerationLog {
  id              String         @id @default(cuid())

  projectId       String?
  project         Project?       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sceneId         String?
  scene           Scene?         @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  level           LogLevel       @default(INFO)
  step            GenerationStep
  message         String         @db.Text

  provider        String?
  requestPayload  Json?
  responsePayload Json?

  durationMs      Int?
  costEstimateUSD Float?

  errorCode       String?
  errorDetails    Json?

  createdAt       DateTime       @default(now())

  @@index([projectId])
  @@index([sceneId])
  @@index([step])
  @@index([level])
  @@index([createdAt])
}

// ============================================================================
// IDENTITY PROFILES (Digital Twin)
// ============================================================================

model IdentityProfile {
  id              String    @id @default(cuid())
  name            String    @unique      // e.g., "deven-primary"
  displayName     String                 // e.g., "Deven Spear"
  description     String?   @db.Text

  // LoRA Configuration
  triggerWord     String    @unique      // e.g., "TOK_DEVEN"
  loraKey         String?                // R2 key for .safetensors file
  loraUrl         String?                // Full URL (for Fal.ai)
  loraScale       Float     @default(0.95)
  baseModel       String    @default("flux-dev")  // "flux-dev" or "flux-schnell"

  // Voice Configuration
  voiceId         String?               // ElevenLabs voice ID
  voiceModel      String    @default("eleven_turbo_v2_5")
  voiceStability  Float     @default(0.5)
  voiceSimilarity Float     @default(0.8)
  voiceStyle      Float     @default(0.2)
  voiceSpeakerBoost Boolean @default(true)

  // Status
  isDefault       Boolean   @default(false)
  isActive        Boolean   @default(true)

  // Relations
  scenes          Scene[]   @relation("SceneIdentity")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([isDefault])
  @@index([isActive])
}

// ============================================================================
// SYSTEM SETTINGS
// ============================================================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt
}

// ============================================================================
// ADMIN AUTHENTICATION
// ============================================================================

model AdminSession {
  id           String   @id @default(cuid())
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  @@index([token])
  @@index([expiresAt])
}
